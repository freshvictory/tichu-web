<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tichu Scorer</title>

    <style>
      html {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji",
          "Segoe UI Symbol";
      }

      * {
        box-sizing: border-box;
      }

      body,
      button,
      h1,
      fieldset,
      input {
        border: none;
        padding: 0;
        margin: 0;
      }

      button,
      input {
        font: inherit;
      }

      button {
        appearance: none;
        cursor: pointer;
      }

      input[type="range"] {
        appearance: none;
      }
    </style>

    <style>
      :root {
        --font-large: 1.25rem;
        --font-heading: 1.5rem;
        --spacing-small: 8px;
        --spacing-medium: 16px;
        --spacing-large: 24px;
        --spacing-xlarge: 32px;
      }

      :root {
        --border: 3px solid var(--theme-text);
        --edge: 1px solid var(--theme-background-light);
        --border-radius: 8px;
      }

      :root {
        --c-black: #000;
        --c-light-black: #222;
        --c-gray: #777;
        --c-lightest-gray: #ddd;
        --c-off-white: #efefef;
        --c-white: #fff;

        --theme-accent: hsl(39, 79%, 66%);
        --theme-accent-shadow: hsl(39, 90%, 31%);
        --theme-text: var(--c-light-black);
        --theme-text-light: var(--c-light-black);
        --theme-text-lightest: var(--c-gray);
        --theme-background: var(--c-white);
        --theme-background-off: var(--c-off-white);
        --theme-background-light: var(--c-lightest-gray);

        --team-us-color: #6494ed;
        --team-us-text: #366fd9;
        --team-them-color: #ed7864;
        --team-them-text: #d94e36;
      }
    </style>

    <style>
      .visually-hidden {
        clip: rect(0 0 0 0);
        clip-path: inset(50%);
        height: 1px;
        width: 1px;
        overflow: hidden;
        white-space: nowrap;
        position: absolute;
      }

      html {
        accent-color: var(--theme-accent);
      }

      html,
      body {
        height: 100%;
        overflow: hidden;

        color: var(--theme-text);
        background-color: var(--theme-background);
      }

      output {
        font-variant-numeric: tabular-nums;
      }

      body {
        display: grid;
        grid-template-rows: auto 1fr;
      }

      header {
        text-align: center;
        font-variant-caps: small-caps;
        padding: var(--spacing-small);
      }

      h1 {
        font-size: var(--font-heading);
        display: inline-block;
        background: linear-gradient(
          to top right,
          var(--team-us-text),
          var(--team-them-text)
        );
        background-clip: text;
        color: transparent;
      }

      main {
        padding-block: var(--spacing-large);
        padding-inline: var(--spacing-large);
        min-inline-size: min(100vw, 400px);
        margin-inline: auto;
      }

      form {
        --slider-inline-size: 70px;
        --slider-entries: 31;
        --slider-size-multiple: 12px;
        --slider-block-size: calc(
          var(--slider-entries) * var(--slider-size-multiple)
        ); /* Nice if multiple of 31 */
        block-size: 100%;
      }

      form {
        display: grid;
        grid-template-columns: 1fr auto;
        grid-template-rows: auto 1fr;
        row-gap: var(--spacing-medium);
      }

      form > .points {
        grid-column: 2;
      }

      form > .actions {
        grid-column: span 2;
      }

      .range-container {
        grid-row: 1;
        grid-column: 1;

        display: flex;
        align-items: center;
        justify-content: space-around;

        box-sizing: content-box;
        inline-size: var(--slider-inline-size);
        block-size: var(--slider-block-size);

        border: var(--border);
        border-color: transparent;

        --thumb-color: #2222;
        --thumb-inline-size: calc(1.2 * var(--slider-inline-size));
        --thumb-block-size: var(--tick-block-size);
        --thumb-border: 3px solid var(--theme-background);
        --thumb-border-radius: var(--thumb-block-size);
        --thumb-inline-offset: calc(-0.1 * var(--slider-inline-size));

        --tick-color: var(--theme-background-light);
        --tick-thickness: 3px;
        --tick-block-size: calc(
          var(--slider-block-size) / var(--slider-entries)
        );

        background: linear-gradient(
            to bottom,
            var(--tick-color) var(--tick-thickness),
            transparent 1px
          )
          repeat-y;
        background-size: var(--tick-inline-size) var(--tick-block-size);
        background-position: 0
          calc(var(--tick-block-size) / 2 - var(--tick-thickness) / 2);
      }

      .range-container > input[type="range"] {
        flex-shrink: 0;
      }

      input[type="range"] {
        inline-size: var(--slider-block-size);
        block-size: var(--slider-inline-size);
        transform: rotate(270deg);
        transform-origin: center;
        border-radius: var(--border-radius);

        background-color: transparent;
      }

      input[type="range"]::-webkit-slider-runnable-track {
        inline-size: 100%;
        block-size: 100%;
      }

      input[type="range"]::-moz-range-track {
        inline-size: 100%;
        block-size: 100%;
      }

      input[type="range"]::-webkit-slider-thumb {
        block-size: var(--thumb-inline-size);
        inline-size: var(--thumb-block-size);
        background-color: var(--thumb-color);
        appearance: none;
        box-shadow: none;
        transform: translateY(var(--thumb-inline-offset));
        border: var(--thumb-border);
        -webkit-backdrop-filter: blur(20px);
        backdrop-filter: blur(20px);
        border-radius: var(--thumb-border-radius);
      }

      input[type="range"]::-moz-range-thumb {
        block-size: var(--thumb-inline-size);
        inline-size: var(--thumb-block-size);
        background-color: var(--thumb-color);
        appearance: none;
        box-shadow: none;
        transform: translateY(var(--thumb-inline-offset));
        border: var(--thumb-border);
        backdrop-filter: blur(20px);
        border-radius: var(--thumb-border-radius);
        box-sizing: border-box;
      }

      .points {
        display: grid;
        grid-template-columns: 1fr;
        gap: var(--spacing-small);

        --tick-inline-size: calc(0.15 * var(--slider-inline-size));
      }

      .points > output {
        grid-column: 1;
        grid-row: 1;

        font-weight: bold;
        inline-size: 3ch;
        box-sizing: content-box;
        text-align: right;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: space-between;
        background: linear-gradient(
          to bottom,
          var(--team-us-color),
          var(--team-them-color)
        );
        border-radius: var(--border-radius);
        padding: var(--spacing-small);
        color: var(--theme-background);

        transform: translateX(
          calc(var(--tick-inline-size) + var(--spacing-small))
        );
      }

      .teams {
        display: flex;
        flex-direction: column;
        justify-content: space-between;
      }

      .score {
        display: block;
        inline-size: 4ch;
        box-sizing: content-box;
        font-size: var(--font-heading);
        padding-inline: var(--spacing-large);
        padding-block: var(--spacing-medium);
        text-align: center;
        font-weight: bold;
        background-color: var(--theme-background-off);
        --border-radius: 8px;
      }

      .score#top-score {
        --team-color: var(--team-us-color);
        border-block-end: 4px solid var(--team-color);
        border-start-start-radius: var(--border-radius);
        border-start-end-radius: var(--border-radius);
      }

      .score#bottom-score {
        --team-color: var(--team-them-color);
        border-block-start: 4px solid var(--team-color);
        border-end-start-radius: var(--border-radius);
        border-end-end-radius: var(--border-radius);
      }

      .actions {
        display: grid;
        grid-template-columns: 1fr 2fr;
        gap: var(--spacing-medium);
        align-items: flex-end;
      }

      button[type="submit"] {
        background-color: var(--theme-background-light);
        box-shadow: 0 2px var(--theme-text-lightest);
        font-size: var(--font-large);
        padding-block: var(--spacing-medium);
        padding-inline: var(--spacing-large);
        border-radius: var(--border-radius);
      }

      button[data-theme="primary"] {
        background-color: var(--theme-accent);
        box-shadow: 0 2px var(--theme-accent-shadow);
        font-weight: bold;
      }

      button:active {
        box-shadow: none;
        transform: translateY(2px);
      }
    </style>
  </head>
  <body>
    <header><h1 class="heading">Tichu</h1></header>
    <main>
      <form id="score-form">
        <div class="teams">
          <output
            id="top-score"
            name="topScore"
            class="score"
            for="taken-points
              top-bet
              bottom-bet
              consecutive-none
              consecutive-top
              consecutive-bottom
            "
            form="score-form"
            >0</output
          >

          <output
            id="bottom-score"
            name="bottomScore"
            class="score"
            for="taken-points
            top-bet
            bottom-bet
            consecutive-none
            consecutive-top
            consecutive-bottom
          "
            form="score-form"
            >0</output
          >
        </div>

        <fieldset class="points">
          <legend class="visually-hidden">Points</legend>

          <output id="taken-output" for="taken-points">
            <span id="taken-us">50</span>
            <span id="taken-them">50</span></output
          >

          <label for="taken-points" class="visually-hidden">Taken points</label>
          <div class="range-container">
            <input
              id="taken-points"
              name="takenPoints"
              type="range"
              min="-25"
              max="125"
              step="5"
              value="50"
            />
          </div>
        </fieldset>

        <div class="actions">
          <button
            type="submit"
            data-theme="secondary"
            name="_action"
            value="undo"
            class="submit"
          >
            Undo
          </button>
          <button type="submit" data-theme="primary" class="submit">
            Score
          </button>
        </div>
      </form>
    </main>

    <script type="text/javascript">
      // @ts-check

      /*
       * Taken points slider
       */
      const slider = /** @type {HTMLInputElement} */ (
        document.getElementById("taken-points")
      );
      const sliderOutput = document.getElementById("taken-output");
      const sliderOutputUs = document.getElementById("taken-us");
      const sliderOutputThem = document.getElementById("taken-them");
      slider.addEventListener("input", function () {
        sliderOutputUs.textContent = this.value;
        sliderOutputThem.textContent = 100 - this.value;
        const offset = 25 - parseInt(this.value, 10) / 5;
        sliderOutput.style.setProperty("--value", this.value);
      });

      /*
       * Form
       */
      const topTeamOutput = /** @type {HTMLOutputElement} */ (
        document.getElementById("top-score")
      );
      const bottomTeamOutput = /** @type {HTMLOutputElement} */ (
        document.getElementById("bottom-score")
      );
      const form = /** @type {HTMLFormElement} */ (
        document.getElementById("score-form")
      );
      form.addEventListener("submit", function (event) {
        event.preventDefault();
        const data = new FormData(form);
        if (
          event.submitter instanceof HTMLButtonElement &&
          event.submitter.value === "undo"
        ) {
          undo();
          return;
        }

        const formPoints = data.get("takenPoints");
        const takenPoints =
          typeof formPoints === "string" && !isNaN(parseInt(formPoints, 10))
            ? parseInt(formPoints, 10)
            : 50;

        const points = calculatePoints({ takenPoints });
        updateScore(points);
        updateHistory(points);
      });

      function init() {
        try {
          const score = getStoredScore();
          turnHistory = getStoredHistory();

          renderScore(score);
        } catch (e) {
          console.error("Error reading from local storage", e);
        }
      }

      function getStoredScore() {
        const score = localStorage.getItem("score");

        return JSON.parse(score) || { us: 0, them: 0 };
      }

      /**
       * Take the current turn's point result and update
       * the team scores and local storage.
       *
       * @param points {{us: number, them: number}}
       */
      function updateScore(points) {
        const currentScore = getCurrentScore();

        const score = {
          us: currentScore.us + points.us,
          them: currentScore.them + points.them,
        };

        try {
          localStorage.setItem("score", JSON.stringify(score));
        } catch (e) {
          console.error("Error writing to local storage", e);
        }

        renderScore(score);
      }

      function getStoredHistory() {
        const history = localStorage.getItem("turnHistory");

        return JSON.parse(history) || [];
      }

      function updateHistory(turnScore) {
        turnHistory.push([turnScore.us, turnScore.them]);
      }

      function saveHistory() {
        try {
          localStorage.setItem("turnHistory", JSON.stringify(turnHistory));
        } catch (e) {
          console.error("Error writing to local storage", e);
        }
      }

      function getCurrentScore() {
        return {
          us: parseInt(topTeamOutput.value, 10) || 0,
          them: parseInt(bottomTeamOutput.value, 10) || 0,
        };
      }

      function calculatePoints({ takenPoints }) {
        return {
          us: takenPoints,
          them: 100 - takenPoints,
        };
      }

      function undo() {
        const lastScore = turnHistory.pop();

        if (!lastScore) {
          return;
        }

        const [us, them] = lastScore;

        updateScore({
          us: -us,
          them: -them,
        });
      }

      function renderScore(score) {
        topTeamOutput.value = score.us;
        bottomTeamOutput.value = score.them;
      }

      /** @type {[number, number][]} */
      let turnHistory = [];
      init();
    </script>
  </body>
</html>
